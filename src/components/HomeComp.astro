---
import { Image } from "astro:assets";
import { t } from "astro-i18n";

interface Props {
  Title: string;
  num: string;
  year: string;
  images?: ImageMetadata[];
  video?: { src: string; poster: string }[];
  description: string;
  link: string;
  linkText: string;
  collaborators?: { name: string; link: string }[];
  color: string;
  Category: string;
}

const {
  Title,
  year,
  images = [],
  video = [],
  description,
  link,
  linkText,
  collaborators = [],
  color,
  Category
} = Astro.props;

const totalItems = video.length + images.length + 1;

function isLightColor(hex: string) {
  const c = hex.replace("#", "");
  const r = parseInt(c.substring(0, 2), 16);
  const g = parseInt(c.substring(2, 4), 16);
  const b = parseInt(c.substring(4, 6), 16);
  const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
  return luminance > 0.6;
}

const textColorClass = isLightColor(color) ? "text-black" : "text-white";
---

<div
  class="w-full aspect-video relative flex flex-col"
  data-project
  style={`--project-color: ${color};`}
>

  <!-- HEADER -->
  <div class="md:sticky md:top-0 z-30 flex justify-between w-full p-1 pointer-events-none">
    <div class="bg-black/75 backdrop-blur-xl rounded-md text-white">
      <p class="px-2 py-1 uppercase">{Title}</p>
    </div>
    <div class="bg-black/60 backdrop-blur-xl rounded-md text-white">
      <p class="px-2 py-1 tabular-nums">{year}</p>
    </div>
  </div>

  <!-- MEDIA + OVERLAYS WRAPPER -->
  <div class="relative">

    <!-- MEDIA STRIP -->
    <div
      class="-mt-10 -mb-1 flex overflow-x-auto no-scrollbar snap-x snap-mandatory aspect-video"
      style={`background-color: ${color};`}
      data-media
    >
      {video.map((v, index) => (
        <div class="w-full h-full aspect-video flex-shrink-0 snap-center">
          <video
            src={v.src}
            muted
            autoplay
            loop
            playsinline
            preload={index === 0 ? "auto" : "metadata"}
            poster={v.poster}
            class="w-full h-full object-cover"
          ></video>
        </div>
      ))}

      {images.map((img, index) => (
        <div class="w-full h-full aspect-video flex-shrink-0 snap-center">
          <Image
            src={img}
            alt={`Image ${index + 1}`}
            widths={[640, 960, 1280, 1600, 1920]}
            sizes="100vw"
            format="webp"
            loading={index === 0 ? "eager" : "lazy"}
            fetchpriority={index === 0 ? "high" : "auto"}
            decoding="async"
            class="w-full h-full object-cover"
          />
        </div>
      ))}

      <!-- DESCRIPTION SLIDE -->
      <div class="w-full h-full flex-shrink-0 snap-center flex items-end">
        <div class={`w-2/3 p-4 text-[10px] leading-tight ${textColorClass}`}>
          <p>{Category}</p>
          <p>{description}</p>

          {link && (
            <a href={link} target="_blank" class="underline">
              â†’ {linkText}
            </a>
          )}

          {collaborators.length > 0 && (
            <div class="mt-2">
              <p>{t("index.collab")}:</p>
              {collaborators.map(c =>
                c.link ? (
                  <a href={c.link} target="_blank" class="block underline">
                    {c.name}
                  </a>
                ) : (
                  <p>{c.name}</p>
                )
              )}
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- LEFT GRADIENT -->
    <button
      class="hidden md:block absolute left-0 top-0 h-[calc(100%+2.75rem)] w-[20%] z-20 -mt-10
             opacity-0 hover:opacity-75 transition-opacity duration-200 cursor-pointer"
      style="background: linear-gradient(to right, var(--project-color), transparent);"
      data-prev
      aria-label="Previous slide"
    ></button>

    <!-- RIGHT GRADIENT -->
    <button
      class="hidden md:block absolute right-0 top-0 h-[calc(100%+2.75rem)] w-[20%] z-20 -mt-10
             opacity-0 hover:opacity-75 transition-opacity duration-200 cursor-pointer"
      style="background: linear-gradient(to left, var(--project-color), transparent);"
      data-next
      aria-label="Next slide"
    ></button>

  </div>

  <!-- INDICATOR -->
  <div class="w-full z-30 flex pointer-events-none" data-dots>
    {Array.from({ length: totalItems }).map(() => (
      <span class="h-[3px] flex-1 bg-white opacity-30"></span>
    ))}
  </div>
</div>

<style>
video,
img {
  display: block;
  backface-visibility: hidden;
  transform: translateZ(0);
}
</style>

<script is:inline>
(() => {
  if (window.innerWidth < 768) return;

  document.querySelectorAll("[data-project]").forEach(project => {
    const scroller = project.querySelector("[data-media]");
    const dots = project.querySelectorAll("[data-dots] span");
    const prev = project.querySelector("[data-prev]");
    const next = project.querySelector("[data-next]");

    if (!scroller || !prev || !next) return;

    const slideWidth = () => scroller.clientWidth;
    const maxIndex = dots.length - 1;

    const index = () =>
      Math.round(scroller.scrollLeft / slideWidth());

    const go = i =>
      scroller.scrollTo({
        left: Math.max(0, Math.min(i, maxIndex)) * slideWidth(),
        behavior: "smooth"
      });

    prev.onclick = () => go(index() - 1);
    next.onclick = () => go(index() + 1);

    const update = () => {
      const i = index();
      dots.forEach((d, n) => d.style.opacity = n === i ? "1" : "0.3");
      prev.style.display = i > 0 ? "" : "none";
      next.style.display = i < maxIndex ? "" : "none";
    };

    scroller.addEventListener("scroll", () =>
      requestAnimationFrame(update)
    );

    update();
  });
})();
</script>